AWSTemplateFormatVersion: 2010-09-09
Description: >-
  nta-master

Transform:
  - AWS::Serverless-2016-10-31

Globals:
  Api:
    EndpointConfiguration: REGIONAL
    # BinaryMediaTypes: ['*/*', 'multipart/form-data']  #['*~1*'] also works
    Cors:
      AllowHeaders: "'Content-Type, Authorization, nta-authority-id, username, access-token'"
      AllowMethods: "'POST,GET,PATCH,PUT,DELETE'"
      AllowOrigin: "'*'"

  Function:
    Runtime: nodejs12.x
    MemorySize: 128
    Timeout: 100
    # Environment:
    #   Variables:
    #     INSTITUTE_TABLE: !Ref InstituteTableDynamo

Resources:
  NtaApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      # Domain:
      #   CertificateArn: arn:aws:acm:ap-south-1:725755216375:certificate/4b62cb86-813f-49f9-b526-718c9c21ef28
      #   DomainName: api.nta-sys.tk
      #   EndpointConfiguration: REGIONAL
      #   Route53:
      #     HostedZoneId: Z01515053HIFJUQO6E9NB
      #   BasePath:
      #     - /nta
      Auth:
        AddDefaultAuthorizerToCorsPreflight: False
        DefaultAuthorizer: NTACognitoAuthorizer
        Authorizers:
          NTACognitoAuthorizer:
            UserPoolArn: arn:aws:cognito-idp:ap-south-1:725755216375:userpool/ap-south-1_YOsP7cTUw

  InstituteApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      # Domain:
      #   CertificateArn: arn:aws:acm:ap-south-1:725755216375:certificate/4b62cb86-813f-49f9-b526-718c9c21ef28
      #   DomainName: api.nta-sys.tk
      #   EndpointConfiguration: REGIONAL
      #   Route53:
      #     HostedZoneId: Z01515053HIFJUQO6E9NB
      #   BasePath:
      #     - /institute
      Auth:
        AddDefaultAuthorizerToCorsPreflight: False
        DefaultAuthorizer: NTACognitoAuthorizer
        Authorizers:
          InstituteCognitoAuthorizer:
            UserPoolArn: arn:aws:cognito-idp:ap-south-1:725755216375:userpool/ap-south-1_GYBsglFix
          NTACognitoAuthorizer:
            UserPoolArn: arn:aws:cognito-idp:ap-south-1:725755216375:userpool/ap-south-1_YOsP7cTUw

  GatewayResponseDefault4XX:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type, Authorization'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'POST,GET,PATCH,PUT,DELETE'"
      ResponseType: DEFAULT_4XX
      RestApiId: !Ref NtaApi

  # # NTA Section
  CreateOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrganizationHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationAddressFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgAddressHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/address
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationPhoneNumberFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgPhoneNumberHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/phone
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationEmailIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgEmailIdHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/email
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationRegistrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgRegistrationHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/registration
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationDocumentFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgDocumentHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/document
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationSettingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgSettingsHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/settings
            Method: POST
            RestApiId: !Ref NtaApi

  CreateOrganizationAffiliationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrgAffiliationHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/affiliation
            Method: POST
            RestApiId: !Ref NtaApi

  # TODO:
  GetOrganizationById:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.GetOrgOfCurrentUserHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{id}
            Method: GET
            RestApiId: !Ref InstituteApi

  GetOrgOfCurrentUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.GetOrgOfCurrentUserHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /my-org
            Method: GET
            RestApiId: !Ref InstituteApi

  ListAllNTAAuthoritiesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.listAllNTAAuthoritiesHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /authority
            Method: GET
            RestApiId: !Ref NtaApi

  CreateOrganizationMasterUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.CreateOrganizationMasterUserHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /organization/{orgId}/user/master
            Method: POST
            RestApiId: !Ref NtaApi

  DeleteOrganizationUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.deleteNTAUserHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /user/{mobile}
            Method: DELETE
            RestApiId: !Ref NtaApi

  CheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.checkTokenHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /user/check
            Method: GET
            RestApiId: !Ref NtaApi

  SetNTAPassword:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-authority.newPasswordChallengeHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /user/challenge
            Method: POST
            RestApiId: !Ref NtaApi

  # Create Organization
  CreateFeesHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.createFeesHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head
            Method: POST
            RestApiId: !Ref InstituteApi

  CreateAccountHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.createAccountHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head
            Method: POST
            RestApiId: !Ref InstituteApi

  CreateFeesType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.createFeeTypeHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type
            Method: POST
            RestApiId: !Ref InstituteApi

  # List Organization
  ListFeesHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getFeesHeadListHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head
            Method: GET
            RestApiId: !Ref InstituteApi

  ListAccountsHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getAccountHeadListHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head
            Method: GET
            RestApiId: !Ref InstituteApi

  ListFeesType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getFeeTypeListHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type
            Method: GET
            RestApiId: !Ref InstituteApi

  ListInstituteType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getInstituteTypeListHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/institute/type
            Method: GET
            RestApiId: !Ref InstituteApi

  # Get Organization By Id
  GetFeesHeadByIDFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getFeesHeadMasterByIdHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head/{id}
            Method: GET
            RestApiId: !Ref InstituteApi

  GetFeesTypeByIDFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getFeesTypeByIdHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type/{id}
            Method: GET
            RestApiId: !Ref InstituteApi

  GetAccountsHeadByIDFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.getAccountsHeadByIdHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head/{id}
            Method: GET
            RestApiId: !Ref InstituteApi

  # Check if Organization Exist
  CheckFeesHeadExists:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.checkIfNTAFeesHeadExistsHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head/check
            Method: POST
            RestApiId: !Ref InstituteApi

  CheckFeesTypeExists:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.checkIfNTAFeesTypeExistsHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type/check
            Method: POST
            RestApiId: !Ref InstituteApi

  CheckAccountsHeadExists:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.checkIfNTAAccountsHeadExistsHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head/check
            Method: POST
            RestApiId: !Ref InstituteApi

  # Edit Organization
  EditFeesHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.editFeesHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head/{id}
            Method: POST
            RestApiId: !Ref NtaApi

  EditFeesType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.editFeesTypeHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type/{id}
            Method: POST
            RestApiId: !Ref NtaApi

  EditAccountsHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.editAccountsHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head/{id}
            Method: POST
            RestApiId: !Ref NtaApi

  # Delete Organization
  DeleteFeesHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.deleteFeesHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head/{id}
            Method: DELETE
            RestApiId: !Ref NtaApi

  DeleteFeesType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.deleteFeesTypeHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type/{id}
            Method: DELETE
            RestApiId: !Ref NtaApi

  DeleteAccountsHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.deleteAccountsHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head/{id}
            Method: DELETE
            RestApiId: !Ref NtaApi

  # Status Change of Organization
  StatusChangeFeesHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.statusChangeFeesHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/head/{id}
            Method: PATCH
            RestApiId: !Ref NtaApi

  StatusChangeFeesType:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.statusChangeFeesTypeHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/fees/type/{id}
            Method: PATCH
            RestApiId: !Ref NtaApi

  StatusChangeAccountsHead:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-masters.statusChangeAccountsHeadHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /masters/accounts/head/{id}
            Method: PATCH
            RestApiId: !Ref NtaApi

  CreateInstituteUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/nta-institute.createInstituteUserHandler
      Description: A simple example includes a HTTP post method to add one item to a DynamoDB table.
      Policies:
        - DynamoDBCrudPolicy:
            TableName: "*"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /institute/user
            Method: POST
            RestApiId: !Ref NtaApi

  # # End NTA

Outputs:
  WebEndpoint:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${NtaApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
